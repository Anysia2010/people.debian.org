# This is a magic Makefile which will use jinjatool.py to build a static
# website. It knows how to ask jinjatool.py to calculate dependencies and
# update itself with whatever rules are necessary.
#
JINJATOOL ?= `find . -name jinjatool.py`
MP_RFC822 ?= `find . -name template.md-jinja`

MAKE = make JINJATOOL=$(JINJATOOL) MP_RFC822=$(MP_RFC822) --no-print-directory
TARGETS = find . -name \*.jinja* -o -name \*.md \
            |grep -v -e '.swp$$' -e '.py$$' -e '~$$' |sort \
            |sed -e 's/md$$/html/g' \
                 -e 's/jinja-rss$$/rss/g' \
                 -e 's/jinja-json$$/json/g' \
                 -e 's/jinja-js$$/js/g' \
                 -e 's/jinja$$/html/g'

all:
	@$(TARGETS) |xargs -r $(MAKE)

clean: cleanMakefile
	@$(TARGETS) |xargs -r rm -f

loop: depend
	@while [ 1 ]; do \
	  $(TARGETS) |xargs -r $(MAKE) \
            |grep -v 'up to date' \
            || sleep 1; \
         done

%.rss: %.jinja-rss
	LC_ALL=C $(JINJATOOL) $<:$@

%.json: %.jinja-json
	LC_ALL=C $(JINJATOOL) $<:$@

%.js: %.jinja-js
	LC_ALL=C $(JINJATOOL) $<:$@

%.html: %.jinja
	LC_ALL=C $(JINJATOOL) $<:$@

%.html: %.md
	LC_ALL=C $(JINJATOOL) dir="`pwd`" MP_RFC822_FILE="$<" $(MP_RFC822):$@

%.jinja: %.jinja.py
	(cd $(<D); ./$(<F)) > $@

%.jinja:
	@touch $@

%.jinja-rss:
	@touch $@

%.jinja-json:
	@touch $@

%.jinja-js:
	@touch $@

%.md: %.md.py
	(cd $(<D); ./$(<F)) > $@

%.md:
	@touch $@

%.md-jinja:
	@touch $@

%.html-jinja:
	@touch $@

cleanMakefile:
	@sed '/ $$DEPS$$ /,$$ d' <Makefile >/tmp/Makefile.clean
	@cp -f /tmp/Makefile.clean Makefile
	@rm -f /tmp/Makefile.clean

depend: cleanMakefile
	@echo '## $$DEPS$$ ## AUTOGENERATED LINES FOLLOW ##' >>Makefile
	(export M=$(MP_RFC822); $(JINJATOOL) --deps \
            `find . -name \*.jinja\* |grep -v .swp |sort` \
            `find . -name \*.md -printf "MP_RFC822_FILE=%p $$M:%p\\n" |sort` \
        ) >>Makefile


